name: ğŸš€ Deployment Otomatis ke cPanel

on:
  push:
    branches:
      - main

# Pastikan deploy hanya berjalan satu kali dalam satu waktu
concurrency:
  group: production-deploy
  cancel-in-progress: true

jobs:
  # Job 1: PHP Lint Check (opsional tapi recommended)
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout Kode
        uses: actions/checkout@v4

      - name: ğŸ˜ Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          extensions: mbstring, pdo, pdo_mysql

      - name: ï¿½ Check PHP Syntax
        run: |
          echo "Checking PHP syntax in moe folder..."
          find moe -name "*.php" -print0 | xargs -0 -n1 php -l
          echo "âœ… Syntax check passed!"

  # Job 2: Deploy ke cPanel (hanya jika lint berhasil)
  deploy:
    runs-on: ubuntu-latest
    needs: lint  # Tunggu lint selesai dulu
    
    steps:
      - name: ğŸ“¥ Checkout Kode
        uses: actions/checkout@v4
      
      - name: ğŸš€ Deploy ke cPanel via SCP
        uses: appleboy/scp-action@v0.1.7 
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          passphrase: ${{ secrets.SSH_KEY_PASSPHRASE }} 
          port: 3759
          source: "moe/*"
          target: "/home/akevyrfm/public_html/moe"
          strip_components: 1
          # Exclude file development (tidak perlu di production)
          # .git dan .github otomatis tidak ter-upload karena source hanya moe/*
      
      - name: ğŸ¥ Health Check
        run: |
          echo "â³ Menunggu server siap (15 detik)..."
          sleep 15
          echo "ğŸ” Mengecek https://www.moegypt.com ..."
          
          # Coba akses website, retry sampai 3x
          for i in 1 2 3; do
            if curl -f -s -o /dev/null -w "%{http_code}" https://www.moegypt.com; then
              echo ""
              echo "âœ… Website accessible! (HTTP 200)"
              exit 0
            else
              echo "âš ï¸ Attempt $i gagal, retry..."
              sleep 5
            fi
          done
          
          echo "âŒ Website tidak bisa diakses setelah 3x percobaan!"
          exit 1

      - name: ğŸ“‹ Deploy Summary
        if: success()
        run: |
          echo "=========================================="
          echo "ğŸ‰ DEPLOYMENT BERHASIL!"
          echo "=========================================="
          echo "ğŸ“… Waktu: $(TZ='Asia/Jakarta' date '+%Y-%m-%d %H:%M:%S WIB')"
          echo "ğŸŒ Website: https://www.moegypt.com"
          echo "ğŸ“‚ Target: /home/akevyrfm/public_html"
          echo "=========================================="