name: ğŸš€ Deployment Otomatis ke cPanel

on:
  push:
    branches:
      - main

# Pastikan deploy hanya berjalan satu kali dalam satu waktu
concurrency:
  group: production-deploy
  cancel-in-progress: true

jobs:
  # Job 1: PHP Lint Check (opsional tapi recommended)
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout Kode
        uses: actions/checkout@v4

      - name: ğŸ˜ Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          extensions: mbstring, pdo, pdo_mysql

      - name: ï¿½ Check PHP Syntax
        run: |
          echo "Checking PHP syntax in moe folder..."
          find moe -name "*.php" -print0 | xargs -0 -n1 php -l
          echo "âœ… Syntax check passed!"

  # Job 2: Deploy ke cPanel (hanya jika lint berhasil)
  deploy:
    runs-on: ubuntu-latest
    needs: lint  # Tunggu lint selesai dulu
    
    steps:
      - name: ğŸ“¥ Checkout Kode
        uses: actions/checkout@v4
      
      - name: ğŸš€ Deploy ke cPanel via SCP
        uses: appleboy/scp-action@v0.1.7 
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          passphrase: ${{ secrets.SSH_KEY_PASSPHRASE }} 
          port: 3759
          source: "moe/*"
          target: "/home/akevyrfm/public_html"
          strip_components: 1
          # Exclude file development (tidak perlu di production)
          # .git dan .github otomatis tidak ter-upload karena source hanya moe/*
      
      - name: âœ… Deploy Berhasil
        run: |
          echo "=========================================="
          echo "ğŸ‰ DEPLOYMENT BERHASIL!"
          echo "=========================================="
          echo "ğŸ“… Waktu: $(TZ='Asia/Jakarta' date '+%Y-%m-%d %H:%M:%S WIB')"
          echo "ğŸŒ Website: https://your-domain.com"
          echo "ğŸ“‚ Target: /home/akevyrfm/public_html"
          echo "=========================================="