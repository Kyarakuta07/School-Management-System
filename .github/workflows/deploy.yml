name: ðŸš€ Deployment Otomatis ke cPanel (FTP Sync)

on:
  push:
    branches:
      - main

# Memastikan deploy tidak tabrakan
concurrency:
  group: production-deploy
  cancel-in-progress: true

jobs:
  # Job 1: PHP Lint Check (Memastikan kode tidak error)
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout Kode
        uses: actions/checkout@v4

      - name: ðŸ˜ Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          extensions: mbstring, pdo, pdo_mysql

      - name: ðŸ” Check PHP Syntax
        run: |
          echo "Checking PHP syntax in moe folder..."
          find moe -name "*.php" -print0 | xargs -0 -n1 php -l
          echo "âœ… Syntax check passed!"

  # Job 2: Deploy ke cPanel menggunakan FTP cuyy (Bisa hapus file otomatis)
  # Last updated: 2025-12-17 21:57 WIB - Password updated
  deploy:
    runs-on: ubuntu-latest
    needs: lint
    
    steps:
      - name: ðŸ“¥ Checkout Kode
        uses: actions/checkout@v4
      
      - name: ðŸ“ Generate Version File (Cache Busting)
        run: |
          COMMIT_HASH=$(git rev-parse --short HEAD)
          DEPLOY_TIME=$(date +%s)
          cat > ./moe/core/version.php << EOF
          <?php
          /**
           * Application Version
           * Auto-generated by GitHub Actions on deployment.
           * DO NOT EDIT MANUALLY.
           */
          define('APP_VERSION', '${COMMIT_HASH}');
          define('DEPLOY_TIME', ${DEPLOY_TIME});
          EOF
          echo "âœ… Generated version.php with commit: ${COMMIT_HASH}"
      
      - name: ðŸš€ Sync Files via FTP (Auto-Delete)
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          protocol: ftps
          port: 21
          local-dir: ./moe/
          # Pakai ./ karena akun matthew sudah dikunci ke folder moe
          server-dir: ./
          # Incremental sync - hanya upload file yang berubah
          # Exclude list akan bekerja sempurna untuk protect production files
          dangerous-clean-slate: false
          exclude: |
            **/.git*
            **/node_modules/**
            **/.env*
            **/*.env
            .env
            .htaccess
            **/.htaccess
            cgi-bin/
            *.log
            **/*.log
            error_log
            repository/
            temp/
            **/temp/
            uploads/
            **/uploads/
            sessions/
            **/sessions/
            cache/
            **/cache/
            *.sql
            *.sql.gz
            *.bak
            *.backup
      
      - name: ðŸ¥ Health Check
        run: |
          echo "â³ Menunggu server sinkronisasi (10 detik)..."
          sleep 10
          echo "ðŸ” Mengecek https://www.moegypt.com ..."
          
          for i in 1 2 3; do
            if curl -f -s -o /dev/null -w "%{http_code}" https://www.moegypt.com; then
              echo "âœ… Website accessible! (HTTP 200)"
              exit 0
            else
              echo "âš ï¸ Attempt $i gagal, retry..."
              sleep 5
            fi
          done
          
          echo "âŒ Website tidak bisa diakses!"
          exit 1

      - name: ðŸ“‹ Deploy Summary
        if: success()
        run: |
          echo "=========================================="
          echo "ðŸŽ‰ DEPLOYMENT BERHASIL & SYNCED!"
          echo "=========================================="
          echo "ðŸ“… Waktu: $(TZ='Asia/Jakarta' date '+%Y-%m-%d %H:%M:%S WIB')"
          echo "ðŸŒ Website: https://www.moegypt.com"
          echo "ðŸ“‚ Target: /home/akevyrfm/public_html/moe"
          echo "ðŸ§¹ Status: Auto-Delete Active"
          echo "=========================================="