name: ðŸ§ª Pre-Production Checks

on:
  push:
    branches:
      - develop
      - feature/*
  pull_request:
    branches:
      - main

# Prevent concurrent runs
concurrency:
  group: pre-production-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Job 1: PHP Lint Check
  lint:
    name: ðŸ˜ PHP Lint
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸ˜ Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          extensions: mbstring, pdo, pdo_mysql

      - name: ðŸ” PHP Syntax Check
        run: |
          echo "Checking PHP syntax..."
          find moe -name "*.php" -print0 | xargs -0 -n1 php -l
          echo "âœ… Syntax check passed!"

  # Job 2: Build Assets
  build:
    name: ðŸ”¨ Build Assets
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ðŸ“¥ Install Dependencies
        run: npm ci

      - name: ðŸ”¨ Build Assets
        run: npm run build

      - name: ðŸ“¤ Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/
          retention-days: 7

  # Job 3: Run Tests
  test:
    name: ðŸ§ª PHPUnit Tests
    runs-on: ubuntu-latest
    needs: lint
    continue-on-error: true
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸ˜ Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          extensions: mbstring, pdo, pdo_mysql

      - name: ðŸ“¥ Install Composer Dependencies
        run: composer install --prefer-dist --no-progress

      - name: ðŸ§ª Run PHPUnit Tests
        run: vendor/bin/phpunit --testdox
        continue-on-error: true

  # Job 4: PR Comment (only on Pull Request)
  pr-check:
    name: ðŸ“ PR Status
    runs-on: ubuntu-latest
    needs: [lint, build, test]
    if: github.event_name == 'pull_request'
    steps:
      - name: ï¿½ Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const lintResult = '${{ needs.lint.result }}' === 'success' ? 'âœ…' : 'âŒ';
            const buildResult = '${{ needs.build.result }}' === 'success' ? 'âœ…' : 'âŒ';
            const testResult = '${{ needs.test.result }}' === 'success' ? 'âœ…' : 'âš ï¸';
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ðŸ§ª Pre-Production Check Results
              
              | Check | Status |
              |-------|--------|
              | PHP Lint | ${lintResult} |
              | Build | ${buildResult} |
              | Tests | ${testResult} |
              
              ${lintResult === 'âœ…' && buildResult === 'âœ…' ? 'âœ… **Ready for merge to main!**' : 'âŒ **Please fix issues before merging.**'}
              
              ---
              *Automated by GitHub Actions*`
            })

  # Job 5: Summary
  summary:
    name: ðŸ“‹ Summary
    runs-on: ubuntu-latest
    needs: [lint, build, test]
    if: always()
    steps:
      - name: ï¿½ Generate Summary
        run: |
          echo "## ðŸ§ª Pre-Production Check Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| PHP Lint | ${{ needs.lint.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tests | ${{ needs.test.result == 'success' && 'âœ… Passed' || 'âš ï¸ Skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“… $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
