{"version":3,"file":"trapeza.js","sources":["../../moe/user/js/trapeza.js"],"sourcesContent":["/**\r\n * TRAPEZA - MOE Banking System Client\r\n * Handles balance, transfers, and transaction history\r\n */\r\n\r\nconst API_BASE = 'api/router.php';\r\n\r\nlet currentBalance = 0;\r\nlet selectedRecipient = null;\r\nlet transferData = {};\r\nlet transactionOffset = 0;\r\nconst TRANSACTIONS_PER_PAGE = 20;\r\n\r\n// ================================================\r\n// INIT & DATA LOADING\r\n// ================================================\r\n\r\ndocument.addEventListener('DOMContentLoaded', () => {\r\n    loadBalance();\r\n    loadRecentTransactions();\r\n    setupEventListeners();\r\n});\r\n\r\nfunction setupEventListeners() {\r\n    // Transfer form\r\n    const transferForm = document.getElementById('transferForm');\r\n    if (transferForm) {\r\n        transferForm.addEventListener('submit', handleTransferSubmit);\r\n    }\r\n\r\n    // Recipient search\r\n    const recipientInput = document.getElementById('recipient');\r\n    if (recipientInput) {\r\n        let searchTimeout;\r\n        recipientInput.addEventListener('input', (e) => {\r\n            clearTimeout(searchTimeout);\r\n            searchTimeout = setTimeout(() => searchRecipients(e.target.value), 300);\r\n        });\r\n    }\r\n\r\n    // Close modals on outside click\r\n    window.addEventListener('click', (e) => {\r\n        if (e.target.classList.contains('modal')) {\r\n            closeAllModals();\r\n        }\r\n    });\r\n}\r\n\r\n// ================================================\r\n// BALANCE\r\n// ================================================\r\n\r\nasync function loadBalance() {\r\n    try {\r\n        const response = await fetch(`${API_BASE}?action=get_balance`);\r\n        const data = await response.json();\r\n\r\n        if (data.success) {\r\n            currentBalance = data.balance;\r\n            document.getElementById('gold-balance').textContent = data.balance.toLocaleString();\r\n        } else {\r\n            showToast(data.error || 'Failed to load balance', 'error');\r\n        }\r\n    } catch (error) {\r\n        console.error('Balance load error:', error);\r\n        showToast('Network error while loading balance', 'error');\r\n    }\r\n}\r\n\r\nfunction refreshBalance() {\r\n    const refreshBtn = document.querySelector('.refresh-btn i');\r\n    refreshBtn.classList.add('fa-spin');\r\n\r\n    loadBalance().finally(() => {\r\n        setTimeout(() => {\r\n            refreshBtn.classList.remove('fa-spin');\r\n        }, 500);\r\n    });\r\n}\r\n\r\n// ================================================\r\n// TRANSACTIONS\r\n// ================================================\r\n\r\nasync function loadRecentTransactions() {\r\n    const container = document.getElementById('recent-transactions');\r\n\r\n    try {\r\n        const response = await fetch(`${API_BASE}?action=get_transactions&limit=5`);\r\n        const data = await response.json();\r\n\r\n        if (data.success) {\r\n            if (data.transactions.length === 0) {\r\n                container.innerHTML = `\r\n                    <div class=\"empty-state\">\r\n                        <i class=\"fas fa-receipt\"></i>\r\n                        <p>No transactions yet</p>\r\n                    </div>\r\n                `;\r\n            } else {\r\n                container.innerHTML = data.transactions.map(t => renderTransactionItem(t)).join('');\r\n            }\r\n        } else {\r\n            container.innerHTML = `<p class=\"error-text\">${data.error}</p>`;\r\n        }\r\n    } catch (error) {\r\n        console.error('Transactions load error:', error);\r\n        container.innerHTML = '<p class=\"error-text\">Failed to load transactions</p>';\r\n    }\r\n}\r\n\r\nasync function loadAllTransactions() {\r\n    const container = document.getElementById('allTransactions');\r\n    const loadMoreBtn = document.getElementById('loadMoreBtn');\r\n\r\n    try {\r\n        const response = await fetch(`${API_BASE}?action=get_transactions&limit=${TRANSACTIONS_PER_PAGE}&offset=${transactionOffset}`);\r\n        const data = await response.json();\r\n\r\n        if (data.success) {\r\n            if (transactionOffset === 0) {\r\n                // First load\r\n                if (data.transactions.length === 0) {\r\n                    container.innerHTML = `\r\n                        <div class=\"empty-state\">\r\n                            <i class=\"fas fa-receipt\"></i>\r\n                            <p>No transactions yet</p>\r\n                        </div>\r\n                    `;\r\n                    loadMoreBtn.classList.remove('show');\r\n                } else {\r\n                    container.innerHTML = data.transactions.map(t => renderTransactionItem(t)).join('');\r\n\r\n                    // Show load more if there are more transactions\r\n                    if (data.total_count > TRANSACTIONS_PER_PAGE) {\r\n                        loadMoreBtn.classList.add('show');\r\n                    }\r\n                }\r\n            } else {\r\n                // Append more\r\n                container.innerHTML += data.transactions.map(t => renderTransactionItem(t)).join('');\r\n\r\n                // Hide load more if we've loaded all\r\n                if (transactionOffset + TRANSACTIONS_PER_PAGE >= data.total_count) {\r\n                    loadMoreBtn.classList.remove('show');\r\n                }\r\n            }\r\n        }\r\n    } catch (error) {\r\n        console.error('All transactions load error:', error);\r\n        if (transactionOffset === 0) {\r\n            container.innerHTML = '<p class=\"error-text\">Failed to load transactions</p>';\r\n        }\r\n    }\r\n}\r\n\r\nfunction loadMoreTransactions() {\r\n    transactionOffset += TRANSACTIONS_PER_PAGE;\r\n    loadAllTransactions();\r\n}\r\n\r\nfunction renderTransactionItem(transaction) {\r\n    const isIncome = transaction.is_income;\r\n    const icon = isIncome ? 'fa-arrow-down' : 'fa-arrow-up';\r\n    const amountClass = isIncome ? 'income' : 'expense';\r\n    const amountSign = isIncome ? '+' : '';\r\n\r\n    // Format date\r\n    const date = new Date(transaction.created_at);\r\n    const dateStr = date.toLocaleDateString('id-ID', {\r\n        day: '2-digit',\r\n        month: 'short',\r\n        year: 'numeric'\r\n    });\r\n    const timeStr = date.toLocaleTimeString('id-ID', {\r\n        hour: '2-digit',\r\n        minute: '2-digit'\r\n    });\r\n\r\n    // Transaction type label\r\n    const typeLabels = {\r\n        'transfer': isIncome ? `From ${transaction.other_party}` : `To ${transaction.other_party}`,\r\n        'purchase': 'Purchase',\r\n        'battle_reward': 'Battle Reward',\r\n        'gacha': 'Gacha Roll',\r\n        'shop': 'Shop Purchase',\r\n        'sell_pet': 'Pet Sale',\r\n        'daily_reward': 'Daily Reward',\r\n        'admin_adjust': 'Admin Adjustment',\r\n        'evolution': 'Pet Evolution'\r\n    };\r\n\r\n    const typeLabel = typeLabels[transaction.type] || transaction.type;\r\n\r\n    return `\r\n        <div class=\"transaction-item\">\r\n            <div class=\"transaction-left\">\r\n                <div class=\"transaction-icon ${amountClass}\">\r\n                    <i class=\"fas ${icon}\"></i>\r\n                </div>\r\n                <div class=\"transaction-info\">\r\n                    <div class=\"transaction-type\">${typeLabel}</div>\r\n                    <div class=\"transaction-description\">${transaction.description || '-'}</div>\r\n                </div>\r\n            </div>\r\n            <div class=\"transaction-right\">\r\n                <div class=\"transaction-amount ${amountClass}\">\r\n                    ${amountSign}${Math.abs(transaction.amount).toLocaleString()}\r\n                    <i class=\"fas fa-coins\" style=\"font-size: 0.8rem; margin-left: 3px;\"></i>\r\n                </div>\r\n                <div class=\"transaction-date\">${dateStr} ${timeStr}</div>\r\n            </div>\r\n        </div>\r\n    `;\r\n}\r\n\r\n// ================================================\r\n// RECIPIENT SEARCH\r\n// ================================================\r\n\r\nlet searchTimeout;\r\nasync function searchRecipients(query) {\r\n    const resultsContainer = document.getElementById('searchResults');\r\n\r\n    if (query.length < 2) {\r\n        resultsContainer.classList.remove('show');\r\n        return;\r\n    }\r\n\r\n    try {\r\n        const response = await fetch(`${API_BASE}?action=search_nethera&query=${encodeURIComponent(query)}`);\r\n        const data = await response.json();\r\n\r\n        if (data.success) {\r\n            if (data.results.length === 0) {\r\n                resultsContainer.innerHTML = '<div class=\"search-result-item\">No users found</div>';\r\n            } else {\r\n                resultsContainer.innerHTML = data.results.map(user => `\r\n                    <div class=\"search-result-item\" onclick=\"selectRecipient('${user.username}', '${user.nama_lengkap}')\">\r\n                        <div class=\"result-username\">@${user.username}</div>\r\n                        <div class=\"result-name\">${user.nama_lengkap}</div>\r\n                    </div>\r\n                `).join('');\r\n            }\r\n            resultsContainer.classList.add('show');\r\n        }\r\n    } catch (error) {\r\n        console.error('Search error:', error);\r\n    }\r\n}\r\n\r\nfunction selectRecipient(username, fullName) {\r\n    selectedRecipient = username;\r\n    document.getElementById('recipient').value = username;\r\n    document.getElementById('searchResults').classList.remove('show');\r\n}\r\n\r\n// ================================================\r\n// TRANSFER\r\n// ================================================\r\n\r\nfunction handleTransferSubmit(e) {\r\n    e.preventDefault();\r\n\r\n    const recipient = document.getElementById('recipient').value.trim();\r\n    const amount = parseInt(document.getElementById('amount').value);\r\n    const description = document.getElementById('description').value.trim() || 'Gold transfer';\r\n\r\n    // Validation\r\n    if (!recipient) {\r\n        showToast('Please select a recipient', 'error');\r\n        return;\r\n    }\r\n\r\n    if (amount < 10) {\r\n        showToast('Minimum transfer amount is 10 gold', 'error');\r\n        return;\r\n    }\r\n\r\n    if (amount > 1000) {\r\n        showToast('Maximum transfer amount is 1000 gold', 'error');\r\n        return;\r\n    }\r\n\r\n    if (amount > currentBalance) {\r\n        showToast('Insufficient funds', 'error');\r\n        return;\r\n    }\r\n\r\n    // Store transfer data\r\n    transferData = { recipient, amount, description };\r\n\r\n    // Show confirmation\r\n    document.getElementById('confirm-recipient').textContent = `@${recipient}`;\r\n    document.getElementById('confirm-amount').textContent = `${amount.toLocaleString()} gold`;\r\n    document.getElementById('confirm-description').textContent = description;\r\n\r\n    closeTransferModal();\r\n    openConfirmModal();\r\n}\r\n\r\nasync function executeTransfer() {\r\n    try {\r\n        const response = await fetch(`${API_BASE}?action=transfer_gold`, {\r\n            method: 'POST',\r\n            headers: { 'Content-Type': 'application/json' },\r\n            body: JSON.stringify({\r\n                recipient_username: transferData.recipient,\r\n                amount: transferData.amount,\r\n                description: transferData.description\r\n            })\r\n        });\r\n\r\n        const data = await response.json();\r\n\r\n        if (data.success) {\r\n            showToast('Transfer successful! âœ…', 'success');\r\n            closeConfirmModal();\r\n\r\n            // Refresh data\r\n            currentBalance = data.new_balance;\r\n            document.getElementById('gold-balance').textContent = data.new_balance.toLocaleString();\r\n            loadRecentTransactions();\r\n\r\n            // Reset form\r\n            document.getElementById('transferForm').reset();\r\n            selectedRecipient = null;\r\n        } else {\r\n            showToast(data.error || 'Transfer failed', 'error');\r\n            closeConfirmModal();\r\n            openTransferModal();\r\n        }\r\n    } catch (error) {\r\n        console.error('Transfer error:', error);\r\n        showToast('Network error during transfer', 'error');\r\n    }\r\n}\r\n\r\n// ================================================\r\n// MODALS\r\n// ================================================\r\n\r\nfunction openTransferModal() {\r\n    document.getElementById('transferModal').classList.add('show');\r\n}\r\n\r\nfunction closeTransferModal() {\r\n    document.getElementById('transferModal').classList.remove('show');\r\n    document.getElementById('searchResults').classList.remove('show');\r\n}\r\n\r\nfunction openConfirmModal() {\r\n    document.getElementById('confirmModal').classList.add('show');\r\n}\r\n\r\nfunction closeConfirmModal() {\r\n    document.getElementById('confirmModal').classList.remove('show');\r\n}\r\n\r\nfunction showHistory() {\r\n    transactionOffset = 0;\r\n    document.getElementById('historyModal').classList.add('show');\r\n    loadAllTransactions();\r\n}\r\n\r\nfunction closeHistoryModal() {\r\n    document.getElementById('historyModal').classList.remove('show');\r\n}\r\n\r\nfunction closeAllModals() {\r\n    closeTransferModal();\r\n    closeConfirmModal();\r\n    closeHistoryModal();\r\n}\r\n\r\n// ================================================\r\n// TOAST NOTIFICATIONS\r\n// ================================================\r\n\r\nfunction showToast(message, type = 'success') {\r\n    const toast = document.getElementById('toast');\r\n    toast.textContent = message;\r\n    toast.className = `toast ${type} show`;\r\n\r\n    setTimeout(() => {\r\n        toast.classList.remove('show');\r\n    }, 3000);\r\n}\r\n"],"names":["API_BASE","currentBalance","loadBalance","loadRecentTransactions","setupEventListeners","transferForm","handleTransferSubmit","recipientInput","searchTimeout","e","searchRecipients","closeAllModals","data","showToast","error","container","t","renderTransactionItem","transaction","isIncome","icon","amountClass","amountSign","date","dateStr","timeStr","typeLabel","query","resultsContainer","user","recipient","amount","description","closeTransferModal","openConfirmModal","closeConfirmModal","closeHistoryModal","message","type","toast"],"mappings":"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"}