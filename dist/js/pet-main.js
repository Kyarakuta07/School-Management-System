const d="api/router.php",p="../assets/pets/",s={currentTab:"my-pet",userPets:[],activePet:null,shopItems:[],userInventory:[],selectedItemType:null,currentBulkItem:null,currentReviveItem:null,currentShopItem:null,dailyRewardData:null,isGoldCompact:!0};typeof window<"u"&&(Object.defineProperty(window,"userPets",{get:()=>s.userPets,set:e=>{s.userPets=e}}),Object.defineProperty(window,"activePet",{get:()=>s.activePet,set:e=>{s.activePet=e}}));function r(e,n="success"){let t=document.getElementById("toast");t||(t=document.createElement("div"),t.id="toast",t.className="toast",t.innerHTML='<i class="toast-icon fas"></i><span class="toast-message"></span>',document.body.appendChild(t));const o=t.querySelector(".toast-icon"),a=t.querySelector(".toast-message"),i={success:"fa-check-circle",error:"fa-times-circle",warning:"fa-exclamation-circle",info:"fa-info-circle"};o&&(o.className=`toast-icon fas ${i[n]||i.success}`),a&&(a.textContent=e),t.className=`toast ${n}`,t.classList.add("show"),setTimeout(()=>{t.classList.remove("show")},3e3)}function Z(){document.querySelectorAll(".tab-btn").forEach(n=>{n.addEventListener("click",()=>{const t=n.dataset.tab;C(t)})})}function C(e){document.querySelectorAll(".tab-btn").forEach(t=>{t.classList.toggle("active",t.dataset.tab===e)}),document.querySelectorAll(".tab-content, .tab-panel").forEach(t=>{t.classList.toggle("active",t.id===e)}),s.currentTab=e;const n=new CustomEvent("tabChanged",{detail:{tab:e}});document.dispatchEvent(n)}function k(e,n=!0){return n?e>=1e6?(e/1e6).toFixed(1)+"M":e>=1e3?(e/1e3).toFixed(1)+"K":e.toLocaleString():e.toLocaleString()}function w(e){const n=document.getElementById("user-gold");n&&(e!==void 0?(n.textContent=k(e,s.isGoldCompact),n.dataset.fullAmount=e):fetch(`${d}?action=get_shop`).then(t=>t.json()).then(t=>{t.user_gold!==void 0&&(n.textContent=k(t.user_gold,s.isGoldCompact),n.dataset.fullAmount=t.user_gold)}))}function X(){const e=document.getElementById("user-gold");e&&(e.style.cursor="pointer",e.title="Click to toggle format",e.addEventListener("click",n=>{n.stopPropagation(),s.isGoldCompact=!s.isGoldCompact;const t=parseInt(e.dataset.fullAmount||0);e.textContent=k(t,s.isGoldCompact),e.style.transform="scale(1.1)",setTimeout(()=>{e.style.transform="scale(1)"},150)}))}function ee(){const n=new URLSearchParams(window.location.search).get("error");n==="battle_limit"?(r("You have used all 3 daily battles! Come back tomorrow.","warning"),window.history.replaceState({},document.title,window.location.pathname)):n==="missing_pets"&&(r("Invalid battle parameters","error"),window.history.replaceState({},document.title,window.location.pathname))}async function te(){try{const n=await(await fetch(`${d}?action=get_daily_reward`)).json();n.success&&n.can_claim&&(s.dailyRewardData=n,ne(n))}catch(e){console.error("Error checking daily reward:",e)}}function ne(e){const n=document.getElementById("daily-login-modal"),t=document.getElementById("daily-calendar"),o=document.getElementById("daily-current-day"),a=document.getElementById("daily-reward-text"),i=document.getElementById("daily-total-logins");if(!n||!t)return;o.textContent=e.current_day,i.textContent=e.total_logins;let c="";e.reward_gold>0&&(c+=`${e.reward_gold} Gold`),e.reward_item_name&&(c+=(c?" + ":"")+`1 ${e.reward_item_name}`),a.textContent=c;let u="";const g=[7,14,21,28,30];for(let l=1;l<=30;l++){let m="calendar-day",f="üí∞";l<e.current_day?(m+=" claimed",f="‚úì"):l===e.current_day&&(m+=" current",f="üéÅ"),g.includes(l)&&(m+=" special",l!==e.current_day&&l>e.current_day&&(f="‚≠ê")),u+=`
            <div class="${m}">
                <span class="day-num">${l}</span>
                <span class="day-icon">${f}</span>
            </div>
        `}t.innerHTML=u,n.classList.add("show")}async function se(){const e=document.getElementById("claim-reward-btn");e.disabled=!0,e.innerHTML='<i class="fas fa-spinner fa-spin"></i> Claiming...';try{const t=await(await fetch(`${d}?action=claim_daily_reward`,{method:"POST",headers:{"Content-Type":"application/json"}})).json();if(t.success){let o=`Day ${t.claimed_day} reward claimed!`;t.gold_received>0&&(o+=` +${t.gold_received} Gold`),t.item_received&&(o+=` +1 ${t.item_received}`),r(o,"success"),R(),w()}else r(t.error||"Failed to claim reward","error"),e.disabled=!1,e.innerHTML='<i class="fas fa-gift"></i> Claim Reward!'}catch(n){console.error("Error claiming daily reward:",n),r("Network error","error"),e.disabled=!1,e.innerHTML='<i class="fas fa-gift"></i> Claim Reward!'}}function R(){document.getElementById("daily-login-modal").classList.remove("show")}async function y(){try{const n=await(await fetch(`${d}?action=get_pets`)).json();n.success&&(s.userPets=n.pets,window.userPets=s.userPets,N(),document.dispatchEvent(new CustomEvent("petsLoaded")),s.activePet=s.userPets.find(t=>t.is_active),window.activePet=s.activePet,s.activePet&&b())}catch(e){console.error("Error loading pets:",e),r("Failed to load pets","error")}}async function h(){try{const n=await(await fetch(`${d}?action=get_active_pet`)).json();n.success&&n.pet?(s.activePet=n.pet,window.activePet=s.activePet,b(),window.PixiPet&&window.PixiPet.isReady()&&window.PixiPet.load(s.activePet)):j()}catch(e){console.error("Error loading active pet:",e)}}function b(){const e=document.getElementById("no-pet-message"),n=document.getElementById("pet-display-zone"),t=document.getElementById("pet-info-header"),o=document.getElementById("stats-container"),a=document.getElementById("exp-card"),i=document.getElementById("action-buttons");if(!s.activePet){j();return}e.style.display="none",n.style.display="block";const c=P(s.activePet),u=s.activePet.is_shiny?`filter: hue-rotate(${s.activePet.shiny_hue}deg);`:"",g=document.getElementById("pet-img-container");g.innerHTML=`
        <img src="${c}" alt="${s.activePet.species_name}" 
             class="pet-image pet-anim-idle" 
             style="${u}; width: 180px; height: 180px; object-fit: contain; filter: drop-shadow(0 8px 25px rgba(0,0,0,0.6));"
             onerror="this.src='../assets/placeholder.png'">
    `;const l=document.getElementById("shiny-sparkles");l.style.display=s.activePet.is_shiny?"block":"none",t.style.display="block";const m=s.activePet.nickname||s.activePet.species_name;document.getElementById("pet-name").textContent=m,document.getElementById("pet-level").textContent=`Lv.${s.activePet.level}`;const f=document.getElementById("pet-element-badge");f.textContent=s.activePet.element,f.className=`element-badge ${s.activePet.element.toLowerCase()}`;const M=document.getElementById("pet-rarity-badge");M.textContent=s.activePet.rarity,M.className=`rarity-badge ${s.activePet.rarity.toLowerCase()}`;const W=document.getElementById("shiny-tag");W.style.display=s.activePet.is_shiny?"inline-flex":"none",o.style.display="grid",$("health",s.activePet.health),$("hunger",s.activePet.hunger),$("mood",s.activePet.mood),a.style.display="block";const A=Math.floor(100*Math.pow(1.2,s.activePet.level-1)),K=s.activePet.exp/A*100;document.getElementById("exp-bar").style.width=`${K}%`,document.getElementById("exp-text").textContent=`${s.activePet.exp} / ${A}`,i.style.display="grid";const B=document.getElementById("btn-shelter");if(B){const I=B.querySelector(".action-label"),E=B.querySelector("i");s.activePet.status==="SHELTER"?(I&&(I.textContent="Retrieve"),E&&(E.className="fas fa-door-open")):(I&&(I.textContent="Shelter"),E&&(E.className="fas fa-home"))}}function $(e,n){const t=document.getElementById(`${e}-ring`),o=document.getElementById(`${e}-value`);if(!t||!o)return;o.textContent=Math.round(n);const a=220,i=a-n/100*a;t.style.strokeDashoffset=i}function j(){const e=document.getElementById("pet-stage");e.innerHTML=`
        <div class="no-pet-message">
            <i class="fas fa-egg fa-3x"></i>
            <p>No active pet!</p>
            <button class="action-btn primary" onclick="switchTab('gacha')">
                Get Your First Pet
            </button>
        </div>
    `,document.getElementById("pet-info").style.display="none",document.getElementById("action-buttons").style.display="none"}async function oe(e){const n=s.userPets.find(t=>t.id===e);if(n){if(n.status==="DEAD"){r("This pet is dead! Use a revival item first.","warning");return}if(n.status==="SHELTER"){confirm(`Retrieve ${n.nickname||n.species_name} from shelter?`)&&L(e);return}try{const o=await(await fetch(`${d}?action=set_active`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({pet_id:e})})).json();o.success?(r("Pet is now active!","success"),await y(),C("my-pet")):r(o.error||"Failed to set active pet","error")}catch(t){console.error("Error setting active pet:",t),r("Network error","error")}}}function ae(){document.getElementById("btn-feed")?.addEventListener("click",()=>{document.dispatchEvent(new CustomEvent("openItemModal",{detail:{type:"food"}}))}),document.getElementById("btn-heal")?.addEventListener("click",()=>{document.dispatchEvent(new CustomEvent("openItemModal",{detail:{type:"potion"}}))}),document.getElementById("btn-play")?.addEventListener("click",H),document.getElementById("btn-shelter")?.addEventListener("click",()=>L())}async function H(){if(s.activePet){if(s.activePet.status==="DEAD"){r("This pet is dead! Use a revival item first.","warning");return}window.PetAnimations&&(window.PetAnimations.jump(),window.PetAnimations.hearts(3)),r("You played with "+(s.activePet.nickname||s.activePet.species_name)+"! üéµ","success"),setTimeout(()=>{const e=document.getElementById("rhythm-modal");e&&(e.classList.add("show"),typeof startRhythmGame=="function"&&startRhythmGame())},500)}}async function L(e=null){const n=e||(s.activePet?s.activePet.id:null);if(n)try{const o=await(await fetch(`${d}?action=shelter`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({pet_id:n})})).json();o.success?(r(o.message,"success"),h(),y()):r(o.error||"Failed to toggle shelter","error")}catch(t){console.error("Error toggling shelter:",t)}}function P(e){const n=e.evolution_stage||"egg";let t;switch(n){case"egg":t=["img_egg","img_baby","img_adult"];break;case"baby":t=["img_baby","img_egg","img_adult"];break;case"adult":t=["img_adult","img_baby","img_egg"];break;default:t=["img_egg","img_baby","img_adult"]}for(const o of t)if(e[o]&&e[o]!==""&&e[o]!==null)return p+e[o];return p+(e.current_image||"default/egg.png")}function N(){const e=document.getElementById("pet-count-badge");if(e){const n=s.userPets.length;e.textContent=`${n} / 25`,n>=25?e.style.background="linear-gradient(135deg, #E74C3C, #C0392B)":n>=20?e.style.background="linear-gradient(135deg, #F39C12, #E67E22)":e.style.background="linear-gradient(135deg, var(--gold), var(--gold-dark))"}}function q(){const e=document.getElementById("collection-grid");if(N(),typeof updateCollectionStats=="function"&&updateCollectionStats(),s.userPets.length===0){e.innerHTML=`
            <div class="empty-message">
                <p>No pets yet! Visit the Gacha tab to get your first companion.</p>
            </div>
        `;return}const n=typeof getFilteredPets=="function"?getFilteredPets():s.userPets;if(n.length===0){e.innerHTML=`
            <div class="empty-message">
                <p>No pets match your search or filter.</p>
            </div>
        `;return}e.innerHTML=n.map(t=>{const o=P(t),a=t.nickname||t.species_name,i=t.is_active?"active":"",c=t.status==="DEAD"?"dead":"",u=t.is_shiny?`filter: hue-rotate(${t.shiny_hue}deg);`:"",l={Fire:"üî•",Water:"üíß",Earth:"üåø",Air:"üí®"}[t.element]||"‚≠ê";let m="";return t.status==="SHELTER"&&(m=`
                <button class="shop-buy-btn" onclick="event.stopPropagation(); selectPet(${t.id})">
                    <i class="fas fa-box-open"></i> Retrieve
                </button>
            `),`
            <div class="pet-card ${i} ${c}" onclick="selectPet(${t.id})">
                <span class="rarity-badge ${t.rarity.toLowerCase()}">${t.rarity}</span>
                <div class="pet-card-element ${t.element.toLowerCase()}" title="${t.element}">
                    ${l}
                </div>
                ${t.is_shiny?'<div class="pet-card-shiny">‚ú®</div>':""}
                <img src="${o}" alt="${t.species_name}" class="pet-card-img" 
                     style="${u}"
                     onerror="this.src='../assets/placeholder.png'">
                <h3 class="pet-card-name">${a}</h3>
                <span class="pet-card-level">Lv.${t.level}</span>
                ${m}
            </div>
        `}).join("")}document.addEventListener("petsLoaded",()=>{q()});async function _(){try{const n=await(await fetch(`${d}?action=get_inventory`)).json();n.success&&(s.userInventory=n.inventory,ie(),D())}catch(e){console.error("Error loading inventory:",e)}}function ie(){const e=document.getElementById("inventory-grid");if(D(),s.userInventory.length===0){e.innerHTML='<p class="empty-message">No items yet</p>';return}e.innerHTML=s.userInventory.map(n=>{let t="common";n.price&&(n.price>=1e3?t="legendary":n.price>=500?t="epic":n.price>=200?t="rare":n.price>=100&&(t="uncommon"));const o=n.quantity===0;return`
        <div class="inventory-item-card ${t} ${o?"depleted":""}" 
             onclick="${o?"void(0)":`handleInventoryClick(
                 ${n.item_id}, 
                 '${n.effect_type}', 
                 '${n.name.replace(/'/g,"\\'")}', 
                 '${n.description?n.description.replace(/'/g,"\\'"):""}', 
                 '${n.img_path}', 
                 ${n.quantity}
             )`}" 
             title="${n.name}${n.description?" - "+n.description:""}">
            <div class="inventory-item-img-wrapper">
                <img src="${p}${n.img_path}" alt="${n.name}"
                     onerror="this.src='../assets/placeholder.png'">
            </div>
            <span class="inventory-qty-badge">${n.quantity}</span>
            <p class="inventory-item-name">${n.name}</p>
        </div>
    `}).join("")}function D(){const e=document.getElementById("inventory-count");if(e){const n=s.userInventory.length;e.textContent=`${n} ${n===1?"item":"items"}`}}async function re(e,n,t,o,a,i){if(n==="gacha_ticket"){confirm(`Apakah kamu ingin menetaskan ${t} sekarang?`)&&v(e,0,1);return}if(n==="revive"){U(e);return}if(!s.activePet){r("Kamu butuh Active Pet untuk menggunakan item ini!","warning");return}if(s.activePet.status==="DEAD"){r("Pet mati. Hidupkan dulu dengan item Revive!","error");return}s.currentBulkItem={id:e,max:i,name:t};const c=document.getElementById("bulk-use-modal");if(!c){confirm(`Gunakan ${t}?`)&&v(e,s.activePet.id,1);return}document.getElementById("bulk-modal-title").textContent=t,document.getElementById("bulk-item-desc").textContent=o,document.getElementById("bulk-item-img").src=p+a,document.getElementById("bulk-item-qty").max=i,document.getElementById("bulk-item-qty").value=1,c.classList.add("show")}function ce(e){const n=document.getElementById("bulk-item-qty");let t=parseInt(n.value)+e;t<1&&(t=1),t>s.currentBulkItem.max&&(t=s.currentBulkItem.max),n.value=t}function le(){document.getElementById("bulk-item-qty").value=s.currentBulkItem.max}function G(){document.getElementById("bulk-use-modal").classList.remove("show"),s.currentBulkItem=null}function de(){if(!s.currentBulkItem||!s.activePet)return;const e=parseInt(document.getElementById("bulk-item-qty").value);v(s.currentBulkItem.id,s.activePet.id,e),G()}async function v(e,n=0,t=1){try{const a=await(await fetch(`${d}?action=use_item`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({pet_id:n,item_id:e,quantity:t})})).json();a.success?(a.is_gacha&&a.gacha_data?(document.dispatchEvent(new CustomEvent("showGachaResult",{detail:a.gacha_data})),r("Telur berhasil menetas!","success")):(window.PetAnimations&&(a.effect_type==="food"||a.hunger_restored?(window.PetAnimations.food(t),window.PetAnimations.jump()):a.effect_type==="potion"||a.health_restored?(window.PetAnimations.sparkles(6),window.PetAnimations.lottie("healing",1500)):a.effect_type==="revive"&&(window.PetAnimations.revive(),window.PetAnimations.lottie("sparkles",2e3)),a.exp_gained&&a.exp_gained>0&&window.PetAnimations.showExp(a.exp_gained)),r(a.message,"success")),document.getElementById("item-modal")&&F(),h(),_(),y()):r(a.error||"Failed to use item","error")}catch(o){console.error("Error using item:",o)}}function O(e){if(!s.activePet)return;s.selectedItemType=e;const n=document.getElementById("item-modal"),t=document.getElementById("item-list"),o=s.userInventory.filter(a=>a.effect_type===e);o.length===0?t.innerHTML='<div class="empty-message">No items! Visit shop.</div>':t.innerHTML=o.map(a=>`
            <div class="item-option" onclick="useItem(${a.item_id}, ${s.activePet.id}, 1)">
                <img src="${p}${a.img_path}" onerror="this.src='../assets/placeholder.png'">
                <div class="item-option-name">${a.name}</div>
                <div class="item-option-qty">x${a.quantity}</div>
            </div>
        `).join(""),n.classList.add("show")}function F(){document.getElementById("item-modal").classList.remove("show"),s.selectedItemType=null}function U(e,n,t){if(s.currentReviveItem=s.userInventory.find(i=>i.item_id===e),!s.currentReviveItem){r("Item not found","error");return}const o=s.userPets.filter(i=>i.status==="DEAD");if(o.length===0){r("No dead pets to revive!","info");return}const a=document.getElementById("dead-pets-list");a.innerHTML=o.map(i=>{const c=P(i),u=i.nickname||i.species_name;return`
            <div class="dead-pet-card" onclick="revivePet(${i.id})">
                <img src="${c}" alt="${u}" 
                     onerror="this.src='../assets/placeholder.png'">
                <div class="dead-overlay"></div>
                <p>${u}</p>
                <span class="rarity-badge ${i.rarity.toLowerCase()}">${i.rarity}</span>
            </div>
        `}).join(""),document.getElementById("revive-modal").classList.add("show")}function J(){document.getElementById("revive-modal").classList.remove("show"),s.currentReviveItem=null}async function me(e){s.currentReviveItem&&(await v(s.currentReviveItem.item_id,e,1),J())}document.addEventListener("openItemModal",e=>{O(e.detail.type)});async function ue(e){const n=document.getElementById("gacha-egg");n?.classList.add("hatching");let t="standard";e==="premium"&&(t="premium");try{const a=await(await fetch(`${d}?action=gacha`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({type:t})})).json();setTimeout(()=>{n?.classList.remove("hatching"),a.success?(x(a),w(a.remaining_gold),y()):r(a.error||"Gacha failed","error")},500)}catch(o){console.error("Error performing gacha:",o),n?.classList.remove("hatching"),r("Network error","error")}}function x(e){const n=document.getElementById("gacha-modal"),t=n?.querySelector(".gacha-result-modal"),o=e.species;if(!n||!t)return;t.classList.remove("rarity-common","rarity-rare","rarity-epic","rarity-legendary"),t.classList.add(`rarity-${e.rarity.toLowerCase()}`),document.getElementById("result-pet-img").src=p+(o.img_egg||"default/egg.png"),document.getElementById("result-name").textContent=o.name;const a=document.getElementById("result-rarity");a.textContent=e.rarity,a.className=`rarity-badge-large ${e.rarity.toLowerCase()}`;const i=document.getElementById("result-element");i&&o.element&&(i.textContent=o.element);const c=document.getElementById("result-title"),g={Common:"New Pet!",Rare:"Nice Pull!",Epic:"Amazing!",Legendary:"üéâ LEGENDARY! üéâ"}[e.rarity]||"Congratulations!";c.innerHTML=`<i class="fas fa-sparkles"></i><span>${g}</span>`;const l=document.getElementById("result-shiny");if(e.is_shiny?(document.getElementById("result-pet-img").style.filter=`hue-rotate(${e.shiny_hue}deg) drop-shadow(0 10px 40px rgba(0, 0, 0, 0.6))`,l.style.display="flex"):(document.getElementById("result-pet-img").style.filter="drop-shadow(0 10px 40px rgba(0, 0, 0, 0.6))",l.style.display="none"),n.classList.add("show"),window.PetAnimations){const m=document.getElementById("result-pet-img");m&&(m.style.animation="none",setTimeout(()=>{m.style.animation="pet-reveal 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275)"},10))}}function pe(){document.getElementById("gacha-modal")?.classList.remove("show"),y()}document.addEventListener("showGachaResult",e=>{x(e.detail)});function ye(){document.querySelectorAll(".shop-tab-pill").forEach(e=>{e.addEventListener("click",()=>{document.querySelectorAll(".shop-tab-pill").forEach(n=>n.classList.remove("active")),e.classList.add("active"),Y(e.dataset.shop)})})}async function Q(){try{const n=await(await fetch(`${d}?action=get_shop`)).json();n.success?(s.shopItems=n.items||[],console.log("Shop loaded:",s.shopItems.length,"items"),w(n.user_gold),Y("food")):console.error("Shop load failed:",n.error)}catch(e){console.error("Error loading shop:",e)}}function fe(e){return e==="food"?"food":e==="potion"||e==="revive"?"potion":"special"}function ge(e,n){const t=e.toLowerCase();if(t.includes("kibble"))return"fa-drumstick-bite";if(t.includes("feast"))return"fa-turkey";if(t.includes("banquet"))return"fa-crown";if(t.includes("fish"))return"fa-fish";if(t.includes("meat"))return"fa-bacon";if(t.includes("elixir"))return"fa-flask";if(t.includes("vitality"))return"fa-heart-pulse";if(t.includes("phoenix"))return"fa-fire-flame-curved";if(t.includes("tears"))return"fa-droplet";if(t.includes("health"))return"fa-flask-vial";if(t.includes("exp")||t.includes("boost"))return"fa-arrow-up";if(t.includes("gacha")||t.includes("ticket"))return"fa-ticket";if(t.includes("shield"))return"fa-shield-halved";if(t.includes("star"))return"fa-star";if(t.includes("scroll"))return"fa-scroll";if(t.includes("soul"))return"fa-ghost";if(t.includes("ankh"))return"fa-ankh";if(t.includes("wisdom"))return"fa-book";const o=fe(n);return o==="food"?"fa-drumstick-bite":o==="potion"?"fa-flask":"fa-star"}function Y(e){const n=document.getElementById("shop-grid");let t=s.shopItems;if(e==="food"?t=s.shopItems.filter(o=>o.effect_type==="food"):e==="potion"?t=s.shopItems.filter(o=>o.effect_type==="potion"||o.effect_type==="revive"):e==="special"&&(t=s.shopItems.filter(o=>o.effect_type==="exp_boost"||o.effect_type==="gacha_ticket"||o.effect_type==="shield")),t.length===0){n.innerHTML='<div class="shop-empty"><i class="fas fa-box-open"></i><br>No items in this category</div>';return}n.innerHTML=t.map(o=>{const a=ge(o.name,o.effect_type);let i="common";o.price>=1e3?i="legendary":o.price>=500?i="epic":o.price>=200?i="rare":o.price>=100&&(i="uncommon");const c=o.is_new||!1;return`
            <div class="shop-item-card ${i}" onclick="buyItem(${o.id})">
                ${c?'<span class="new-badge">NEW</span>':""}
                <div class="shop-item-icon-wrapper ${i}">
                    <i class="fas ${a}"></i>
                </div>
                <h4 class="shop-item-name">${o.name}</h4>
                <p class="shop-item-desc">${o.description||""}</p>
                <div class="shop-item-footer">
                    <div class="shop-item-price">
                        <i class="fas fa-coins"></i>
                        <span>${o.price}</span>
                    </div>
                    <button class="shop-buy-btn" onclick="event.stopPropagation(); buyItem(${o.id})">
                        <i class="fas fa-cart-plus"></i>
                        Buy
                    </button>
                </div>
            </div>
        `}).join("")}function he(e){const n=parseInt(e),t=s.shopItems.find(o=>parseInt(o.id)===n);if(!t){console.log("shopItems:",s.shopItems,"searching for:",n),r("Item not found. Please refresh the page.","error");return}s.currentShopItem=t,document.getElementById("shop-modal-img").src=p+(t.img_path||"placeholder.png"),document.getElementById("shop-modal-name").textContent=t.name,document.getElementById("shop-modal-desc").textContent=t.description,document.getElementById("shop-unit-price").textContent=t.price,document.getElementById("shop-qty-input").value=1,S(),document.getElementById("shop-purchase-modal").classList.add("show")}function z(){document.getElementById("shop-purchase-modal").classList.remove("show"),s.currentShopItem=null}function ve(e){const n=document.getElementById("shop-qty-input");let t=parseInt(n.value)||1;t=Math.max(1,Math.min(99,t+e)),n.value=t,S()}function S(){if(!s.currentShopItem)return;const n=(parseInt(document.getElementById("shop-qty-input").value)||1)*s.currentShopItem.price;document.getElementById("shop-total-price").textContent=n.toLocaleString()}async function we(){if(!s.currentShopItem)return;const e=parseInt(document.getElementById("shop-qty-input").value)||1;try{const t=await(await fetch(`${d}?action=buy_item`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({item_id:s.currentShopItem.id,quantity:e})})).json();t.success?(r(t.message||`Purchased ${e}x ${s.currentShopItem.name}!`,"success"),w(t.remaining_gold),_(),z()):r(t.error||"Purchase failed","error")}catch(n){console.error("Error buying item:",n),r("Network error","error")}}function Ie(){document.querySelectorAll(".arena-tab").forEach(e=>{e.addEventListener("click",()=>{document.querySelectorAll(".arena-tab").forEach(t=>t.classList.remove("active")),e.classList.add("active");const n=e.dataset.view;document.getElementById("arena-opponents").style.display=n==="opponents"?"block":"none",document.getElementById("arena-history").style.display=n==="history"?"block":"none",n==="opponents"?T():V()})})}async function T(){const e=document.getElementById("arena-opponents");e.innerHTML='<div class="loading-spinner"><i class="fas fa-spinner fa-spin fa-2x"></i><p>Finding opponents...</p></div>';try{const t=await(await fetch(`${d}?action=get_opponents`)).json();t.success&&t.opponents.length>0?e.innerHTML=t.opponents.map(o=>`
                <div class="opponent-card">
                    <img src="${p}${o.img_adult}" alt="${o.species_name}" class="opponent-img"
                         onerror="this.src='../assets/placeholder.png'">
                    <div class="opponent-info">
                        <h3 class="opponent-name">${o.display_name}</h3>
                        <p class="opponent-owner">Owner: ${o.owner_name}</p>
                        <div class="opponent-stats">
                            <span class="element-badge ${o.element.toLowerCase()}">${o.element}</span>
                            <span class="pet-level">Lv.${o.level}</span>
                        </div>
                    </div>
                    <button class="battle-btn" onclick="startBattle(${o.pet_id})">
                        <i class="fas fa-bolt"></i> Fight
                    </button>
                </div>
            `).join(""):e.innerHTML='<div class="empty-message">No opponents available right now. Check back later!</div>'}catch(n){console.error("Error loading opponents:",n),e.innerHTML='<div class="empty-message">Failed to load opponents</div>'}}function Ee(e){if(!s.activePet){r("You need an active pet to battle!","warning");return}if(s.activePet.status==="DEAD"){r("Cannot battle with a dead pet!","error");return}window.location.href=`battle_arena.php?attacker_id=${s.activePet.id}&defender_id=${e}`}function be(e){const n=document.getElementById("battle-modal"),t=document.getElementById("battle-title");e.winner_pet_id===e.attacker.pet_id?(t.textContent="üëë Victory!",t.style.color="#2ecc71"):e.winner_pet_id===e.defender.pet_id?(t.textContent="üíÄ Defeat",t.style.color="#e74c3c"):(t.textContent="‚öñÔ∏è Draw",t.style.color="#f39c12"),document.getElementById("battle-atk-name").textContent=e.attacker.name,document.getElementById("battle-atk-hp").textContent=e.attacker.final_hp,document.getElementById("battle-def-name").textContent=e.defender.name,document.getElementById("battle-def-hp").textContent=e.defender.final_hp;const o=document.getElementById("battle-log");o.innerHTML=e.battle_log.map(i=>`
        <div class="battle-log-entry">
            Round ${i.round}: <strong>${i.actor}</strong> ${i.action}s for <span style="color: #e74c3c">${i.damage}</span> damage!
        </div>
    `).join("");const a=document.getElementById("battle-rewards");e.winner_pet_id===e.attacker.pet_id&&e.rewards?(document.getElementById("reward-gold").textContent=e.rewards.gold,document.getElementById("reward-exp").textContent=e.rewards.exp,a.style.display="flex"):a.style.display="none",n.classList.add("show")}function Pe(){document.getElementById("battle-modal").classList.remove("show")}async function V(){const e=document.getElementById("battle-history");try{const t=await(await fetch(`${d}?action=battle_history`)).json();t.success&&t.battles.length>0?e.innerHTML=t.battles.map(o=>`
                    <div class="battle-history-item">
                        <div class="battle-header">
                            <span class="battle-date">${new Date(o.created_at).toLocaleDateString()}</span>
                        </div>
                        <div class="battle-participants">
                            <span>${o.atk_display}</span>
                            <span class="battle-vs">VS</span>
                            <span>${o.def_display}</span>
                        </div>
                    </div>
                `).join(""):e.innerHTML='<div class="empty-message">No battles yet. Challenge someone!</div>'}catch(n){console.error("Error loading battle history:",n)}}console.log("üêæ MOE Pet System - ES6 Modules Loaded");document.addEventListener("DOMContentLoaded",()=>{console.log("üöÄ Initializing Pet System..."),Z(),ae(),ye(),Ie(),X(),y(),te(),ee(),console.log("‚úÖ Pet System Ready!")});document.addEventListener("tabChanged",e=>{switch(e.detail.tab){case"my-pet":s.activePet?b():h();break;case"collection":y();break;case"gacha":break;case"shop":Q(),_();break;case"arena":h(),T();break}});window.showToast=r;window.switchTab=C;window.updateGoldDisplay=w;window.claimDailyReward=se;window.closeDailyModal=R;window.selectPet=oe;window.playWithPet=H;window.toggleShelter=L;window.renderActivePet=b;window.loadPets=y;window.loadActivePet=h;window.getPetImagePath=P;window.renderCollection=q;window.handleInventoryClick=re;window.adjustQty=ce;window.setMaxQty=le;window.closeBulkModal=G;window.confirmBulkUse=de;window.useItem=v;window.openItemModal=O;window.closeItemModal=F;window.openReviveModal=U;window.closeReviveModal=J;window.revivePet=me;window.loadInventory=_;window.performGacha=ue;window.showGachaResult=x;window.closeGachaModal=pe;window.buyItem=he;window.closeShopPurchaseModal=z;window.adjustShopQty=ve;window.updateShopTotal=S;window.confirmShopPurchase=we;window.loadShop=Q;window.startBattle=Ee;window.showBattleResult=be;window.closeBattleModal=Pe;window.loadOpponents=T;window.loadBattleHistory=V;
//# sourceMappingURL=pet-main.js.map
