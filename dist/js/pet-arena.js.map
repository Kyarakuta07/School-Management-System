{"version":3,"file":"pet-arena.js","sources":["../../moe/user/js/pet_arena.js"],"sourcesContent":["/**\r\n * MOE Pet System - Arena & Achievements Module\r\n * Mediterranean of Egypt Virtual Pet Companion\r\n * Handles Arena battles and Achievements/Badges\r\n */\r\n\r\n// ================================================\r\n// ARENA SYSTEM\r\n// ================================================\r\n\r\n// Load opponents for arena battles\r\nasync function loadOpponents() {\r\n    const container = document.getElementById('arena-opponents');\r\n    if (!container) {\r\n        console.error('arena-opponents element not found');\r\n        return;\r\n    }\r\n\r\n    container.innerHTML = '<div class=\"loading-spinner\"><i class=\"fas fa-spinner fa-spin fa-2x\"></i><p>Finding opponents...</p></div>';\r\n\r\n    try {\r\n        const response = await fetch('api/router.php?action=get_opponents');\r\n        const data = await response.json();\r\n\r\n        if (data.success && data.opponents && data.opponents.length > 0) {\r\n            container.innerHTML = data.opponents.map((opp, index) => {\r\n                // Calculate stat percentages for mini bars\r\n                const hpPercent = Math.min((opp.hp / 100) * 100, 100);\r\n                const atkPercent = Math.min((opp.atk / 100) * 100, 100);\r\n                const defPercent = Math.min((opp.def / 100) * 100, 100);\r\n\r\n                // Mock win/loss data (replace with actual data from API)\r\n                const wins = opp.wins || Math.floor(Math.random() * 50);\r\n                const losses = opp.losses || Math.floor(Math.random() * 20);\r\n\r\n                return `\r\n                <div class=\"opponent-card-premium\">\r\n                    <div class=\"opponent-rank\">#${index + 1}</div>\r\n                    <div class=\"opponent-pet-display\">\r\n                        <img src=\"${ASSETS_BASE}${opp.img_adult}\" alt=\"${opp.display_name}\"\r\n                             onerror=\"this.src='../assets/placeholder.png'\">\r\n                        <span class=\"rarity-badge ${(opp.rarity || 'common').toLowerCase()}\">${opp.rarity || 'Common'}</span>\r\n                    </div>\r\n                    <div class=\"opponent-info\">\r\n                        <h4 class=\"pet-name\">${opp.display_name}</h4>\r\n                        <p class=\"pet-level\">Lv. ${opp.level}</p>\r\n                        <div class=\"owner-info\">\r\n                            <i class=\"fas fa-user\"></i>\r\n                            <span>${opp.owner_name}</span>\r\n                            ${opp.sanctuary ? '<span class=\"sanctuary\">' + opp.sanctuary + '</span>' : ''}\r\n                        </div>\r\n                    </div>\r\n                    <div class=\"opponent-stats-preview\">\r\n                        <div class=\"stat-mini\">\r\n                            <span>HP</span>\r\n                            <div class=\"stat-bar\"><div class=\"fill\" style=\"width: ${hpPercent}%\"></div></div>\r\n                        </div>\r\n                        <div class=\"stat-mini\">\r\n                            <span>ATK</span>\r\n                            <div class=\"stat-bar\"><div class=\"fill\" style=\"width: ${atkPercent}%\"></div></div>\r\n                        </div>\r\n                        <div class=\"stat-mini\">\r\n                            <span>DEF</span>\r\n                            <div class=\"stat-bar\"><div class=\"fill\" style=\"width: ${defPercent}%\"></div></div>\r\n                        </div>\r\n                    </div>\r\n                    <div class=\"opponent-record\">\r\n                        <span class=\"wins\">W: ${wins}</span>\r\n                        <span class=\"losses\">L: ${losses}</span>\r\n                    </div>\r\n                    <button class=\"battle-btn-premium\" onclick=\"startBattle(${opp.pet_id})\">\r\n                        <i class=\"fas fa-bolt\"></i>\r\n                        Challenge\r\n                    </button>\r\n                </div>\r\n            `;\r\n            }).join('');\r\n        } else {\r\n            container.innerHTML = '<div class=\"empty-message\">No opponents available right now. Check back later!</div>';\r\n        }\r\n    } catch (error) {\r\n        console.error('Error loading opponents:', error);\r\n        container.innerHTML = '<div class=\"empty-message\">Failed to load opponents</div>';\r\n    }\r\n}\r\n\r\n// Start battle with selected opponent\r\nwindow.startBattle = function (defenderPetId) {\r\n    console.log('Starting battle with defender:', defenderPetId);\r\n\r\n    // Get active pet - try window.activePet first, then search in userPets\r\n    let activePet = window.activePet;\r\n\r\n    // Fallback: find from userPets array if window.activePet not set\r\n    if (!activePet && window.userPets && window.userPets.length > 0) {\r\n        activePet = window.userPets.find(pet => pet.is_active === 1 || pet.is_active === '1');\r\n        console.log('Found active pet from userPets:', activePet);\r\n    }\r\n\r\n    // Check if user has active pet\r\n    if (!activePet) {\r\n        // Use showToast if available, otherwise alert\r\n        if (typeof showToast === 'function') {\r\n            showToast('You need an active pet to battle!', 'warning');\r\n        } else {\r\n            alert('You need an active pet to battle! Please select a pet first.');\r\n        }\r\n        console.error('No active pet found. window.userPets:', window.userPets);\r\n        return;\r\n    }\r\n\r\n    // Check if pet is alive\r\n    if (activePet.status === 'DEAD') {\r\n        if (typeof showToast === 'function') {\r\n            showToast('Cannot battle with a dead pet!', 'error');\r\n        } else {\r\n            alert('Your pet is dead! Revive it first.');\r\n        }\r\n        return;\r\n    }\r\n\r\n    // Redirect to battle arena page\r\n    console.log('Redirecting to battle arena...');\r\n    window.location.href = `battle_arena.php?attacker_id=${activePet.id}&defender_id=${defenderPetId}`;\r\n}\r\n\r\n// ================================================\r\n// ACHIEVEMENTS / BADGES SYSTEM\r\n// ================================================\r\n\r\n// Load achievements/badges\r\nasync function loadAchievements() {\r\n    const container = document.getElementById('achievements-grid');\r\n    if (!container) {\r\n        console.error('achievements-grid element not found');\r\n        return;\r\n    }\r\n\r\n    container.innerHTML = '<div class=\"loading-spinner\"><i class=\"fas fa-spinner fa-spin fa-2x\"></i><p>Loading achievements...</p></div>';\r\n\r\n    try {\r\n        const response = await fetch('api/router.php?action=get_achievements');\r\n        const data = await response.json();\r\n\r\n        if (data.success && data.achievements && data.achievements.length > 0) {\r\n            container.innerHTML = data.achievements.map(ach => {\r\n                const progress = ach.current_progress || 0;\r\n                const total = ach.target_value || 100;\r\n                const percentage = Math.min((progress / total) * 100, 100);\r\n                const isComplete = ach.is_completed || progress >= total;\r\n\r\n                return `\r\n                    <div class=\"achievement-card ${isComplete ? 'completed' : ''}\">\r\n                        <div class=\"achievement-icon\">\r\n                            <i class=\"fas ${ach.icon || 'fa-trophy'}\"></i>\r\n                        </div>\r\n                        <div class=\"achievement-info\">\r\n                            <h4 class=\"achievement-name\">${ach.name}</h4>\r\n                            <p class=\"achievement-desc\">${ach.description}</p>\r\n                            <div class=\"achievement-progress\">\r\n                                <div class=\"progress-bar\">\r\n                                    <div class=\"progress-fill\" style=\"width: ${percentage}%\"></div>\r\n                                </div>\r\n                                <span class=\"progress-text\">${progress} / ${total}</span>\r\n                            </div>\r\n                            ${ach.reward_gold ? `<div class=\"achievement-reward\"><i class=\"fas fa-coins\"></i> ${ach.reward_gold}</div>` : ''}\r\n                        </div>\r\n                        ${isComplete ? '<div class=\"achievement-badge\"><i class=\"fas fa-check\"></i></div>' : ''}\r\n                    </div>\r\n                `;\r\n            }).join('');\r\n        } else {\r\n            container.innerHTML = `\r\n                <div class=\"empty-message\">\r\n                    <i class=\"fas fa-medal\"></i>\r\n                    <p>No achievements yet. Complete challenges to earn badges!</p>\r\n                </div>\r\n            `;\r\n        }\r\n    } catch (error) {\r\n        console.error('Error loading achievements:', error);\r\n        container.innerHTML = '<div class=\"empty-message\">Failed to load achievements</div>';\r\n    }\r\n}\r\n\r\n// ================================================\r\n// 3V3 TEAM BATTLE SYSTEM\r\n// ================================================\r\n\r\n// Load team selection for 3v3 battles\r\nasync function loadTeamSelection() {\r\n    const container = document.getElementById('team-selection');\r\n    if (!container) {\r\n        console.error('team-selection element not found');\r\n        return;\r\n    }\r\n\r\n    container.innerHTML = '<div class=\"loading-spinner\"><i class=\"fas fa-spinner fa-spin fa-2x\"></i><p>Loading your pets...</p></div>';\r\n\r\n    try {\r\n        // Get user's pets from main pet.js\r\n        const userPets = window.userPets;\r\n\r\n        if (!userPets || userPets.length === 0) {\r\n            container.innerHTML = `\r\n                <div class=\"empty-message\">\r\n                    <i class=\"fas fa-paw\"></i>\r\n                    <p>You need pets to form a team! Visit the Gacha tab to get pets.</p>\r\n                </div>\r\n            `;\r\n            return;\r\n        }\r\n\r\n        // Filter alive pets only\r\n        const alivePets = userPets.filter(pet => pet.status !== 'DEAD');\r\n\r\n        if (alivePets.length < 3) {\r\n            container.innerHTML = `\r\n                <div class=\"empty-message\">\r\n                    <i class=\"fas fa-heart-broken\"></i>\r\n                    <p>You need at least 3 alive pets for team battles!</p>\r\n                    <p class=\"text-small\">You have ${alivePets.length} alive pet(s). Heal or get more pets.</p>\r\n                </div>\r\n            `;\r\n            return;\r\n        }\r\n\r\n        // Render team selection\r\n        container.innerHTML = `\r\n            <div class=\"team-info\">\r\n                <p class=\"team-instruction\">\r\n                    <i class=\"fas fa-info-circle\"></i>\r\n                    Select 3 pets for your team. Battles use your top 3 strongest pets.\r\n                </p>\r\n            </div>\r\n            <div class=\"team-grid\">\r\n                ${alivePets.slice(0, 6).map((pet, index) => `\r\n                    <div class=\"team-pet-card ${index < 3 ? 'team-member' : ''}\">\r\n                        <img src=\"${ASSETS_BASE}${pet.img_adult}\" \r\n                             alt=\"${pet.nickname || pet.species_name}\"\r\n                             onerror=\"this.src='../assets/placeholder.png'\">\r\n                        <div class=\"team-pet-info\">\r\n                            <h4>${pet.nickname || pet.species_name}</h4>\r\n                            <div class=\"team-pet-stats\">\r\n                                <span class=\"stat-label\">Lv.${pet.level}</span>\r\n                                <span class=\"element-badge ${pet.element.toLowerCase()}\">${pet.element}</span>\r\n                            </div>\r\n                            <div class=\"team-pet-combat\">\r\n                                <span title=\"Attack\"><i class=\"fas fa-sword\"></i> ${pet.atk}</span>\r\n                                <span title=\"Defense\"><i class=\"fas fa-shield\"></i> ${pet.def}</span>\r\n                                <span title=\"HP\"><i class=\"fas fa-heart\"></i> ${pet.hp}</span>\r\n                            </div>\r\n                        </div>\r\n                        ${index < 3 ? '<div class=\"team-badge\">Team</div>' : ''}\r\n                    </div>\r\n                `).join('')}\r\n            </div>\r\n            <div class=\"team-summary\">\r\n                <p><strong>Team Power:</strong> ${alivePets.slice(0, 3).reduce((sum, p) => sum + (p.atk + p.def + p.hp), 0)}</p>\r\n            </div>\r\n        `;\r\n\r\n    } catch (error) {\r\n        console.error('Error loading team selection:', error);\r\n        container.innerHTML = '<div class=\"empty-message\">Failed to load team selection</div>';\r\n    }\r\n}\r\n\r\n\r\n// Initialize arena module\r\nconsole.log('âœ“ Arena module loaded');\r\n\r\n// ================================================\r\n// ARENA STATS UPDATE FUNCTION\r\n// ================================================\r\nasync function loadArenaStats() {\r\n    // Show loading state\r\n    const battlesEl = document.getElementById('arena-battles');\r\n    const winsEl = document.getElementById('total-wins');\r\n    const winRateEl = document.getElementById('win-rate');\r\n    const streakEl = document.getElementById('current-streak');\r\n\r\n    // Set loading indicators\r\n    if (battlesEl) battlesEl.innerHTML = '<i class=\"fas fa-spinner fa-spin\"></i>';\r\n    if (winsEl) winsEl.innerHTML = '<i class=\"fas fa-spinner fa-spin\"></i>';\r\n    if (winRateEl) winRateEl.innerHTML = '<i class=\"fas fa-spinner fa-spin\"></i>';\r\n    if (streakEl) streakEl.innerHTML = '<i class=\"fas fa-spinner fa-spin\"></i>';\r\n\r\n    try {\r\n        console.log('ðŸ” Fetching arena stats...');\r\n        const response = await fetch('api/router.php?action=battle_history');\r\n\r\n        if (!response.ok) {\r\n            throw new Error(`HTTP ${response.status}: ${response.statusText}`);\r\n        }\r\n\r\n        const data = await response.json();\r\n        console.log('ðŸ“Š API Response:', data);\r\n\r\n        if (data.success) {\r\n            const stats = data.stats || {};\r\n            const wins = stats.wins || 0;\r\n            const losses = stats.losses || 0;\r\n            const streak = stats.current_streak || 0;\r\n            const battlesRemaining = stats.battles_remaining !== undefined ? stats.battles_remaining : 3;\r\n\r\n            console.log('âœ… Stats parsed:', { wins, losses, streak, battlesRemaining });\r\n\r\n            // Update stats bar\r\n            updateArenaStats(wins, losses, streak);\r\n\r\n            // Update battles remaining display\r\n            if (battlesEl) {\r\n                battlesEl.textContent = `${battlesRemaining} / 3`;\r\n            }\r\n\r\n            console.log('âœ… Arena stats updated successfully');\r\n        } else {\r\n            console.error('âŒ API returned success: false', data);\r\n            throw new Error(data.error || 'Failed to load stats');\r\n        }\r\n    } catch (error) {\r\n        console.error('âŒ Error loading arena stats:', error);\r\n\r\n        // Reset to default values on error\r\n        if (battlesEl) battlesEl.textContent = '3 / 3';\r\n        if (winsEl) winsEl.textContent = '0';\r\n        if (winRateEl) winRateEl.textContent = '0%';\r\n        if (streakEl) streakEl.textContent = '0';\r\n\r\n        // Show error toast if available\r\n        if (typeof showToast === 'function') {\r\n            showToast('Failed to load arena stats', 'error');\r\n        }\r\n    }\r\n}\r\n\r\nfunction updateArenaStats(wins, losses, streak) {\r\n    // Update wins\r\n    const winsEl = document.getElementById('total-wins');\r\n    if (winsEl) winsEl.textContent = wins || 0;\r\n\r\n    // Calculate and update win rate\r\n    const total = (wins || 0) + (losses || 0);\r\n    const winRate = total > 0 ? Math.round((wins / total) * 100) : 0;\r\n    const winRateEl = document.getElementById('win-rate');\r\n    if (winRateEl) winRateEl.textContent = `${winRate}%`;\r\n\r\n    // Update streak\r\n    const streakEl = document.getElementById('current-streak');\r\n    if (streakEl) streakEl.textContent = streak || 0;\r\n}\r\n\r\n// Initialize arena stats when tab is opened\r\ndocument.addEventListener('DOMContentLoaded', () => {\r\n    // Load stats when Arena tab is clicked\r\n    const arenaTab = document.querySelector('[data-tab=\"arena\"]');\r\n    if (arenaTab) {\r\n        arenaTab.addEventListener('click', () => {\r\n            setTimeout(loadArenaStats, 100);\r\n        });\r\n    }\r\n\r\n    // Also load if already on arena tab\r\n    const arenaContent = document.getElementById('arena');\r\n    if (arenaContent && arenaContent.classList.contains('active')) {\r\n        loadArenaStats();\r\n    }\r\n\r\n    //Reload stats whenever tab becomes visible (catches return from battle)\r\n    document.addEventListener('visibilitychange', () => {\r\n        if (!document.hidden) {\r\n            const arenaContent = document.getElementById('arena');\r\n            if (arenaContent && arenaContent.classList.contains('active')) {\r\n                loadArenaStats();\r\n            }\r\n        }\r\n    });\r\n});\r\n"],"names":["defenderPetId","activePet","pet","loadArenaStats","battlesEl","winsEl","winRateEl","streakEl","response","data","stats","wins","losses","streak","battlesRemaining","updateArenaStats","error","total","winRate","arenaTab","arenaContent"],"mappings":"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"}